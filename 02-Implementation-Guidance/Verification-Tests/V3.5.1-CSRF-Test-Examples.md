# Verification Test: Cross-Site Request Forgery (CSRF) Protection

This document provides high-level examples of test cases for verifying that
an application's CSRF protection mechanisms are implemented correctly. These
tests are designed to validate the principles outlined in the
`Anti-CSRF-Implementation.md` pattern.

- **Target ASVS Requirement:** V3.5.1 (Verify anti-forgery tokens are used
  to protect against CSRF attacks).
- **Related Implementation Pattern:** `../Patterns/Anti-CSRF-Implementation.md`

---

## 1. Manual Test Case Description

This test can be performed by a developer or QA engineer using browser
developer tools.

**Objective:** To confirm that a state-changing request (e.g., submitting a
form to update a user profile) fails if the anti-CSRF token is missing or
incorrect.

### Test Steps

1. **Establish a Session:** Log in to the application as a standard user.
2. **Navigate to a Form:** Go to a page with a form that performs a
   state-changing action, such as an "Update Profile" page.
3. **Inspect the Form:** Use your browser's developer tools to inspect the
   HTML of the form. Find the hidden input field for the CSRF token (e.g.,
   `<input type="hidden" name="_csrf" value="abc123...">`) and copy its
   value.
4. **Tamper with the Token:**
   - **Test Case A (Missing Token):** In the developer tools, delete the
     hidden CSRF token input field from the form's HTML entirely.
   - **Test Case B (Invalid Token):** In the developer tools, change the
     value of the hidden CSRF token to a different, static value (e.g.,
     "invalid-token").
5. **Submit the Form:** For both Test Case A and B, submit the modified form.
6. **Verify the Outcome:**
   - **Expected Result:** The server must reject the request. The
     application should return an HTTP error code (typically `403 Forbidden`
     or `400 Bad Request`) and should **not** update the user's profile.
   - **Failure Condition:** If the user's profile is successfully updated
     in either test case, the application is vulnerable to CSRF.

---

## 2. Automated Integration Test Example (Pseudocode)

This example uses a Python `pytest`-like syntax to demonstrate how to
automate the verification of a CSRF-protected API endpoint.

**Objective:** To programmatically verify that an endpoint rejects requests
with missing or invalid CSRF tokens.

```python
# This is a conceptual integration test, not a unit test.
# It assumes you have a test client that can make authenticated requests.

def test_profile_update_rejects_missing_csrf_token(authenticated_client):
    """
    ASVS V3.5.1: Verifies that a POST request fails if the
    CSRF token is not provided.
    """
    # ARRANGE: Prepare the data for the profile update.
    profile_data = {"email": "new.email@example.com"}

    # ACT: Make a POST request WITHOUT the CSRF token header.
    response = authenticated_client.post(
        "/api/profile/update", data=profile_data)

    # ASSERT: The server must reject the request.
    assert response.status_code == 403  # Or 400
    assert get_user_email_from_db() != "new.email@example.com"


def test_profile_update_rejects_invalid_csrf_token(authenticated_client):
    """
    ASVS V3.5.1: Verifies that a POST request fails if the
    CSRF token is incorrect.
    """
    # ARRANGE: Prepare the data and an invalid token.
    profile_data = {"email": "new.email@example.com"}
    invalid_headers = {"X-CSRF-Token": "this-is-not-a-valid-token"}

    # ACT: Make the POST request with the invalid token.
    response = authenticated_client.post(
        "/api/profile/update", data=profile_data, headers=invalid_headers)

    # ASSERT: The server must reject the request.
    assert response.status_code == 403
    assert get_user_email_from_db() != "new.email@example.com"


def test_profile_update_succeeds_with_valid_csrf_token(
        authenticated_client_with_csrf):
    """
    Verifies the happy path to ensure functionality is not broken.
    The `authenticated_client_with_csrf` fixture would handle
    fetching a valid token.
    """
    # ARRANGE: Prepare the data. The client fixture adds the valid token.
    profile_data = {"email": "new.email@example.com"}

    # ACT: Make the request.
    response = authenticated_client_with_csrf.post(
        "/api/profile/update", data=profile_data)

    # ASSERT: The request should succeed.
    assert response.status_code == 200
    assert get_user_email_from_db() == "new.email@example.com"
```
